<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV → TradingView Integration Demo</title>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root { --bg:#0b0f14; --fg:#e3e7ed; --muted:#8da2b8; --line:#1a2433; }
    html,body { height:100%; margin:0; }
    body { background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    header, footer { padding:12px 16px; border-bottom:1px solid var(--line); }
    header { display:flex; gap:12px; align-items:center; }
    .container { padding:16px; max-width:980px; margin:0 auto; }
    #chart { height: 70vh; }
    a { color:#9ecbff; }
    .pill { background:#141b29; color:#cbd3df; padding:4px 8px; border:1px solid #26324a; border-radius:999px; font-size:12px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    button { background:#141b29; border:1px solid #26324a; color:#cbd3df; padding:6px 10px; border-radius:6px; cursor:pointer; }
    button.active { background:#2b3955; }
  </style>
</head>
<body>
  <header class="container">
    <div><strong>CSV:LOCAL</strong> <span class="pill">Public demo</span></div>
    <div style="flex:1"></div>
    <div class="toolbar">
      <button data-res="60" class="active">1h</button>
      <button data-res="240">4h</button>
      <button data-res="D">1D</button>
    </div>
  </header>

  <div class="container">
    <div id="chart"></div>
    <p style="color:var(--muted)">
      This public, non‑commercial page demonstrates a CSV‑backed chart. After TradingView grants access,
      this URL will embed the TradingView Charting Library using the same data. No broker/paywall.
    </p>
  </div>

  <footer class="container" style="display:flex;justify-content:space-between;align-items:center">
    <div>Contact: <a href="mailto:you@yourdomain.dev">you@yourdomain.dev</a> • <a href="./privacy.html">Privacy</a></div>
    <div><a href="https://github.com/yourusername/tv-csv-demo">GitHub repo</a></div>
  </footer>

  <script>
    const container = document.getElementById('chart');
    const chart = LightweightCharts.createChart(container, {
      layout: { background: { color: '#0b0f14' }, textColor:'#cbd3df' },
      grid: { vertLines: { color:'#152033' }, horzLines: { color:'#152033' } },
      rightPriceScale: { borderColor:'#1a2433' },
      timeScale: { borderColor:'#1a2433' },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
    });
    const series = chart.addCandlestickSeries();

    function resolutionToSec(res) {
      const s = String(res).toUpperCase();
      if (s === 'D') return 86400;
      if (s === 'W') return 7*86400;
      if (s.endsWith('H')) return Number(s.replace('H',''))*3600;
      const n = Number(s); return Number.isFinite(n) ? n*60 : 3600;
    }

    function splitCSVLine(line){
      const out=[]; let cur='',q=false;
      for(let i=0;i<line.length;i++){const ch=line[i];
        if(ch=='"'){ if(q && line[i+1]=='"'){cur+='"'; i++;} else q=!q; }
        else if(ch==',' && !q){ out.push(cur); cur=''; }
        else cur+=ch;
      }
      out.push(cur); return out.map(s=>s.trim());
    }

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      const headers = lines.shift().split(',').map(s => s.trim().toLowerCase());
      const idx = n => headers.findIndex(h => n.includes(h));
      const ti = idx(['time','timestamp','date','datetime']);
      const oi = idx(['open','o']), hi = idx(['high','h']), li = idx(['low','l']), ci = idx(['close','c']);
      const vi = idx(['volume','v']);

const parseTime = (s) => {
  const v = String(s).trim();
  // pure digits: epoch sec or ms
  if (/^\d+$/.test(v)) return v.length > 10 ? Number(v) : Number(v) * 1000;

  // Try native ISO first
  let t = Date.parse(v);
  if (Number.isFinite(t)) return t;

  // Handle DD-MM-YYYY[T or space]HH:mm[:ss]
  const m = v.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})[T\s](\d{2}):(\d{2})(?::(\d{2}))?$/);
  if (m) {
    const [, dd, mm, yyyy, HH, MM, SS] = m;
    // Treat as UTC; change to Date if you want local time
    return Date.UTC(+yyyy, +mm - 1, +dd, +HH, +MM, +(SS || 0));
  }
  return NaN;
};

      const bars = [];
      for (const line of lines) {
        const cols = splitCSVLine(line);
        const t = parseTime(cols[ti]); const o = +cols[oi]; const h = +cols[hi]; const l = +cols[li]; const c = +cols[ci];
        if (![t,o,h,l,c].every(Number.isFinite)) continue;
        const v = vi >= 0 ? (+cols[vi] || 0) : 0;
        bars.push({ time: Math.floor(t/1000), open:o, high:h, low:l, close:c, volume:v });
      }
      bars.sort((a,b)=>a.time-b.time);
      return bars;
    }

    function aggregate(bars, resSec) {
      const buckets = new Map();
      for (const b of bars) {
        const t0 = Math.floor(b.time / resSec) * resSec;
        const a = buckets.get(t0);
        if (!a) buckets.set(t0, { time:t0, open:b.open, high:b.high, low:b.low, close:b.close, volume:b.volume||0 });
        else { a.high=Math.max(a.high,b.high); a.low=Math.min(a.low,b.low); a.close=b.close; a.volume+=(b.volume||0); }
      }
      return [...buckets.values()].sort((a,b)=>a.time-b.time);
    }

    async function load(res='60') {
      const text = await fetch('data/sample.csv', { cache: 'no-store' }).then(r => r.text());
      const raw = parseCSV(text);
      const resSec = resolutionToSec(res);
      const data = aggregate(raw, resSec).map(b => ({ time:b.time, open:b.open, high:b.high, low:b.low, close:b.close }));
      series.setData(data);
      document.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.res===res));
    }

    // resolution buttons
    document.querySelectorAll('button[data-res]').forEach(btn=>{
      btn.addEventListener('click', ()=>load(btn.dataset.res));
    });

    load('60');
    window.addEventListener('resize', () => chart.applyOptions({ width: container.clientWidth }));
  </script>
</body>
</html>
